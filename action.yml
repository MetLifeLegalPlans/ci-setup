name: 'Configure CI'
description: 'Sets up docker containers and starts them'
inputs:
  with-odbc:
    description: 'Whether to install the ODBC driver'
    required: false
    default: false
  aws-access-key-id:
    description: 'AWS Access Key ID'
    required: false
  aws-secret-access-key:
    description: 'AWS Secret Access Key'
    required: false
  dockerhub-username:
    description: 'Username for Docker Hub'
    required: true
  dockerhub-password:
    description: 'Password/token for Docker Hub'
    required: true

runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v2

    - uses: prewk/s3-cp-action@v2
      with:
        aws_access_key_id: ${{ inputs.aws-access-key-id }}
        aws_secret_access_key: ${{ secrets.aws-secret-access-key }}
        source: 's3://com.willing.members.dependencies/odbc-driver.zip'
        dest: './backend/odbc-driver.zip'
      if: inputs.with-odbc

    - uses: docker/login-action@v1
      with:
        username: ${{ inputs.dockerhub-username }}
        password: ${{ input.dockerhub-password }}

    - run: docker-compose pull
      shell: bash

    - uses: satackey/action-docker-layer-caching@v0.0.11
      continue-on-error: true

    - run: docker-compose up --build -d
      shell: bash

    - run: sleep 10
      shell: bash
